<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Google Drive OAuth - Secure Implementation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d73a49;
        }
        .config-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .config-item {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .config-label {
            font-weight: 500;
            min-width: 120px;
        }
        .config-value {
            font-family: 'Courier New', monospace;
            color: #0969da;
            word-break: break-all;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Google Drive OAuth Test</h1>
        <p class="subtitle">Secure Implementation using Google Identity Services</p>
        
        <div id="status" class="status info">
            Ready to test Google Drive OAuth integration
        </div>

        <div class="config-section">
            <h2>üìã Configuration</h2>
            <div class="config-item">
                <span class="config-label">Client ID:</span>
                <span class="config-value">530840260937-mj2gegc043c3tb69geppdq7mpmb9ah3r.apps.googleusercontent.com</span>
            </div>
            <div class="config-item">
                <span class="config-label">Scopes:</span>
                <span class="config-value">drive.file, userinfo.email, userinfo.profile</span>
            </div>
            <div class="config-item">
                <span class="config-label">Auth Method:</span>
                <span class="config-value">Implicit Flow (No client secret needed)</span>
            </div>
        </div>

        <div class="test-section">
            <h2>üß™ Test OAuth Flow</h2>
            <div class="button-group">
                <button id="connectBtn" onclick="connectGoogleDrive()">
                    Connect Google Drive
                </button>
                <button id="checkBtn" onclick="checkConnection()" disabled>
                    Check Connection
                </button>
                <button id="uploadBtn" onclick="testUpload()" disabled>
                    Test Upload
                </button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>
                    Disconnect
                </button>
            </div>
        </div>

        <div class="test-section">
            <h2>üîß Debug Tests</h2>
            <div class="button-group">
                <button onclick="testAuthUrl()">Test Auth URL (Redirect)</button>
                <button onclick="clearStorage()">Clear Storage</button>
                <button onclick="showToken()">Show Token</button>
            </div>
        </div>

        <div class="log" id="log">
            <div class="log-entry">Waiting for action...</div>
        </div>
    </div>

    <!-- Load Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <script>
        const CLIENT_ID = '530840260937-mj2gegc043c3tb69geppdq7mpmb9ah3r.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';
        
        let tokenClient = null;
        let accessToken = null;
        let gapiInited = false;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            entry.style.borderLeftColor = type === 'error' ? '#dc3545' : 
                                         type === 'success' ? '#28a745' : 
                                         type === 'warning' ? '#ffc107' : '#667eea';
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }
        
        // Initialize Google API
        window.onload = function() {
            log('Initializing Google APIs...');
            
            // Load GAPI
            if (window.gapi) {
                gapi.load('client', initializeGapiClient);
            } else {
                log('Waiting for GAPI to load...', 'warning');
                setTimeout(window.onload, 100);
            }
        };
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                gapiInited = true;
                log('‚úÖ GAPI client initialized', 'success');
                
                // Initialize token client
                initializeTokenClient();
            } catch (error) {
                log(`‚ùå Failed to initialize GAPI: ${error.message}`, 'error');
            }
        }
        
        function initializeTokenClient() {
            if (!window.google || !window.google.accounts) {
                log('Waiting for Google Identity Services...', 'warning');
                setTimeout(initializeTokenClient, 100);
                return;
            }
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error) {
                        log(`‚ùå Token error: ${response.error}`, 'error');
                        updateStatus(`Authentication failed: ${response.error}`, 'error');
                        return;
                    }
                    
                    accessToken = response.access_token;
                    localStorage.setItem('gdrive_token', JSON.stringify({
                        access_token: response.access_token,
                        expires_at: Date.now() + (response.expires_in * 1000)
                    }));
                    
                    log(`‚úÖ Token received! Expires in ${response.expires_in} seconds`, 'success');
                    updateStatus('Successfully connected to Google Drive!', 'success');
                    
                    // Enable buttons
                    document.getElementById('checkBtn').disabled = false;
                    document.getElementById('uploadBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('connectBtn').textContent = 'Reconnect';
                }
            });
            
            log('‚úÖ Token client initialized', 'success');
            updateStatus('Ready to connect to Google Drive', 'info');
            
            // Check for existing token
            checkExistingToken();
        }
        
        function checkExistingToken() {
            const stored = localStorage.getItem('gdrive_token');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (data.expires_at > Date.now()) {
                        accessToken = data.access_token;
                        log('Found existing valid token', 'success');
                        updateStatus('Already connected to Google Drive', 'success');
                        document.getElementById('checkBtn').disabled = false;
                        document.getElementById('uploadBtn').disabled = false;
                        document.getElementById('disconnectBtn').disabled = false;
                        document.getElementById('connectBtn').textContent = 'Reconnect';
                    } else {
                        log('Existing token expired', 'warning');
                        localStorage.removeItem('gdrive_token');
                    }
                } catch (e) {
                    log('Invalid stored token', 'warning');
                }
            }
        }
        
        function connectGoogleDrive() {
            if (!tokenClient) {
                log('Token client not initialized', 'error');
                updateStatus('Please wait for initialization to complete', 'warning');
                return;
            }
            
            log('Requesting access token...');
            updateStatus('<span class="spinner"></span> Authenticating with Google...', 'info');
            
            // Request token with consent
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        async function checkConnection() {
            if (!accessToken) {
                log('No access token available', 'error');
                updateStatus('Not connected to Google Drive', 'error');
                return;
            }
            
            log('Checking connection...');
            updateStatus('<span class="spinner"></span> Verifying connection...', 'info');
            
            try {
                // Set token for GAPI
                gapi.client.setToken({ access_token: accessToken });
                
                // Try to list files
                const response = await gapi.client.drive.files.list({
                    pageSize: 1,
                    fields: 'files(id, name)'
                });
                
                log(`‚úÖ Connection verified! Found ${response.result.files ? response.result.files.length : 0} files`, 'success');
                updateStatus('Connection to Google Drive is active', 'success');
            } catch (error) {
                log(`‚ùå Connection check failed: ${error.message}`, 'error');
                updateStatus('Connection verification failed', 'error');
                
                if (error.status === 401) {
                    log('Token may be expired, please reconnect', 'warning');
                    accessToken = null;
                    localStorage.removeItem('gdrive_token');
                }
            }
        }
        
        async function testUpload() {
            if (!accessToken) {
                log('No access token available', 'error');
                updateStatus('Please connect to Google Drive first', 'error');
                return;
            }
            
            log('Starting test upload...');
            updateStatus('<span class="spinner"></span> Uploading test file...', 'info');
            
            try {
                // Create a test file
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                
                const metadata = {
                    'name': `test-file-${Date.now()}.txt`,
                    'mimeType': 'text/plain'
                };
                
                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: text/plain\r\n\r\n' +
                    'This is a test file uploaded via Google Drive API' +
                    close_delim;
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': `multipart/related; boundary="${boundary}"`
                    },
                    body: multipartRequestBody
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ File uploaded successfully! ID: ${result.id}`, 'success');
                    updateStatus(`Test file uploaded! <a href="https://drive.google.com/file/d/${result.id}/view" target="_blank">View in Drive</a>`, 'success');
                } else {
                    const error = await response.text();
                    throw new Error(error);
                }
            } catch (error) {
                log(`‚ùå Upload failed: ${error.message}`, 'error');
                updateStatus('Upload test failed', 'error');
            }
        }
        
        function disconnect() {
            accessToken = null;
            localStorage.removeItem('gdrive_token');
            
            log('Disconnected from Google Drive', 'warning');
            updateStatus('Disconnected from Google Drive', 'warning');
            
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('connectBtn').textContent = 'Connect Google Drive';
            
            // Optionally revoke the token
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    log('Token revoked', 'success');
                });
            }
        }
        
        function testAuthUrl() {
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${CLIENT_ID}&` +
                `redirect_uri=http://localhost:5173/auth/google/callback&` +
                `response_type=code&` +
                `scope=${encodeURIComponent(SCOPES)}&` +
                `access_type=offline&` +
                `prompt=consent`;
            
            log(`Testing auth URL redirect...`);
            log(`Opening: ${authUrl.substring(0, 100)}...`);
            
            window.open(authUrl, '_blank');
        }
        
        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('Cleared all storage', 'warning');
            updateStatus('Storage cleared - refresh page to reinitialize', 'warning');
        }
        
        function showToken() {
            if (accessToken) {
                log(`Token: ${accessToken.substring(0, 20)}...`, 'info');
                const stored = localStorage.getItem('gdrive_token');
                if (stored) {
                    const data = JSON.parse(stored);
                    const expiresIn = Math.round((data.expires_at - Date.now()) / 1000);
                    log(`Expires in: ${expiresIn} seconds`, 'info');
                }
            } else {
                log('No token available', 'warning');
            }
        }
    </script>
</body>
</html>